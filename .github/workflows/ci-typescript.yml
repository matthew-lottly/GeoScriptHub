# =============================================================================
# GeoScriptHub — CI Pipeline: TypeScript Widgets
# =============================================================================
# Triggers on any push or pull-request that touches files under:
#   - tools/typescript/**
#
# Steps per widget:
#   1. tsc --noEmit  — compile-time type check (no output files)
#   2. eslint        — linting
#   3. vite build    — production bundle (verifies the build succeeds)
# =============================================================================

name: CI — TypeScript

on:
  push:
    paths:
      - "tools/typescript/**"
      - ".github/workflows/ci-typescript.yml"
  pull_request:
    paths:
      - "tools/typescript/**"
      - ".github/workflows/ci-typescript.yml"

jobs:
  build-and-lint:
    name: "${{ matrix.widget }} (Node ${{ matrix.node-version }})"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        node-version: ["18", "20"]
        widget:
          - leaflet-widget-generator
          - map-swiper
          - geojson-diff-viewer

    defaults:
      run:
        working-directory: tools/typescript/${{ matrix.widget }}

    steps:
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # -----------------------------------------------------------------------
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # -----------------------------------------------------------------------
      - name: Type-check with tsc
        run: pnpm exec tsc --noEmit

      # -----------------------------------------------------------------------
      - name: Lint with ESLint
        run: pnpm lint

      # -----------------------------------------------------------------------
      - name: Build production bundle
        run: pnpm build
